=== –ü–û–õ–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –î–õ–Ø –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø ===
–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è: Mon Jan  5 00:14:38     2026
–§–∞–π–ª –≤—ã–≤–æ–¥–∞: project_diagnostic_20260105_001438.txt
=============================================


1. MAKEFILE
===========
.PHONY: help init build run run-dev migrate migrate-create worker test test-api test-db \
        version clean proto proto-all proto-clean proto-help lint vet fmt docker-build \
        docker-run docker-compose-up docker-compose-down install-deps health-check \
        deps-update generate-docs bench load-test security-check dev

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
APP_NAME = user-service
BIN_DIR = bin
BUILD_INFO = $(shell git describe --tags --always 2>/dev/null || echo "dev")
COMMIT_HASH = $(shell git rev-parse --short HEAD 2>/dev/null || echo "unknown")
BUILD_DATE = $(shell date -u '+%Y-%m-%d_%H:%M:%S')
PROTOC_IMAGE = namely/protoc-all:1.51_2
PROTO_ROOT = pkg/proto
GEN_DIR = pkg/gen

# –ì–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
.DEFAULT_GOAL := help

## üìö –ü–æ–º–æ—â—å
help:
	@echo "üë§ User Service - Makefile"
	@echo ""
	@echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
	@echo ""
	@echo "üì¶ Proto —Ñ–∞–π–ª—ã:"
	@echo "  make proto              - Build image and generate all proto files"
	@echo "  make proto-generate     - Generate code for internal use"
	@echo "  make proto-pkg          - Generate code for external services"
	@echo "  make proto-pkg-simple   - Simple version for Windows"
	@echo "  make proto-pkg-script   - Generate via script (recommended)"
	@echo "  make proto-clean        - Clean generated files"
	@echo ""
	@echo "üèóÔ∏è  –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫:"
	@echo "  make build              - –°–±–æ—Ä–∫–∞ –±–∏–Ω–∞—Ä–Ω–∏–∫–∞"
	@echo "  make run                - –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞"
	@echo "  make run-dev            - –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏"
	@echo "  make dev                - –ó–∞–ø—É—Å–∫ —Å hot reload (—Ç—Ä–µ–±—É–µ—Ç—Å—è air)"
	@echo "  make clean              - –û—á–∏—Å—Ç–∫–∞ —Å–±–æ—Ä–∫–∏"
	@echo ""
	@echo "üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:"
	@echo "  make migrate            - –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î"
	@echo "  make migrate-create     - –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é"
	@echo "  make worker             - –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ñ–æ–Ω–æ–≤—ã—Ö –≤–æ—Ä–∫–µ—Ä–æ–≤"
	@echo "  make health-check       - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ —Å–µ—Ä–≤–∏—Å–∞"
	@echo ""
	@echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:"
	@echo "  make test               - –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤"
	@echo "  make test-api           - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API"
	@echo "  make test-db            - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ë–î"
	@echo "  make bench              - –ë–µ–Ω—á–º–∞—Ä–∫–∏"
	@echo "  make load-test          - –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
	@echo "  make lint               - –õ–∏–Ω—Ç–∏–Ω–≥ –∫–æ–¥–∞"
	@echo "  make vet                - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞"
	@echo "  make fmt                - –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞"
	@echo "  make security-check     - –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"
	@echo ""

## üì¶ Proto —Ñ–∞–π–ª—ã
proto: proto-build proto-generate

proto-build:
	@echo "üì¶ Building protoc-go image..."
	docker build -t $(PROTOC_IMAGE) -f infra/protoc-go.Dockerfile .
	@echo "‚úÖ Docker image built"

proto-generate:
	@echo "üîß Generating Go code from shared proto files..."
	docker run --rm \
		-v "$(CURDIR):/workspace" \
		$(PROTOC_IMAGE)
	@echo "‚úÖ Proto files generated"

proto-pkg:
	@echo "üöÄ Generating for external services (in pkg/gen/)..."
	@mkdir -p pkg/gen
	@echo "Using Docker image: $(PROTOC_IMAGE)"
	@docker run --rm \
		-v "$(CURDIR):/workspace" \
		$(PROTOC_IMAGE) \
		sh -c ' \
			echo "Finding proto files..." && \
			find pkg/proto -name "*.proto" | while read f; do \
				echo "Processing $$f" && \
				protoc -I pkg/proto -I /include \
					--go_out=pkg/gen \
					--go_opt=paths=source_relative \
					--go-grpc_out=pkg/gen \
					--go-grpc_opt=paths=source_relative \
					$$f || exit 1; \
			done && \
			echo "‚úÖ Shared library generated in pkg/gen/" \
		'
	@echo "‚úÖ Shared library generated"

proto-pkg-simple:
	@echo "üöÄ Generating for external services (simple version)..."
	@mkdir -p pkg/gen
	@docker run --rm \
		-v "$(CURDIR):/workspace" \
		$(PROTOC_IMAGE) \
		sh -c 'find pkg/proto -name "*.proto" -exec echo "Processing {}" \; -exec protoc -I pkg/proto -I /include --go_out=pkg/gen --go_opt=paths=source_relative --go-grpc_out=pkg/gen --go-grpc_opt=paths=source_relative {} \;'
	@echo "‚úÖ Shared library generated in pkg/gen/"

proto-pkg-script:
	@echo "üöÄ Generating via script..."
	@docker run --rm \
		-v "$(CURDIR):/workspace" \
		$(PROTOC_IMAGE) \
		sh -c ' \
			PROTO_ROOT="pkg/proto" && \
			OUTPUT_DIR="pkg/gen" && \
			mkdir -p $$OUTPUT_DIR && \
			find $$PROTO_ROOT -name "*.proto" | while read proto_file; do \
				echo "üìÅ Processing: $$proto_file" && \
				protoc -I pkg/proto -I /include \
					--go_out=$$OUTPUT_DIR \
					--go_opt=paths=source_relative \
					--go-grpc_out=$$OUTPUT_DIR \
					--go-grpc_opt=paths=source_relative \
					$$proto_file || exit 1; \
			done && \
			echo "‚úÖ Done! Check $$OUTPUT_DIR" \
		'
	@echo "‚úÖ Generated via script"

proto-clean:
	@echo "üßπ Cleaning generated files..."
	@if exist "internal\gen" rmdir /s /q "internal\gen" 2>nul || rm -rf pkg/gen
	@if exist "pkg\gen" rmdir /s /q "pkg\gen" 2>nul || rm -rf pkg/gen
	@echo "‚úÖ Clean complete"

## üèóÔ∏è  –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫
build:
	@echo "üî® Building $(APP_NAME)..."
	mkdir -p $(BIN_DIR)
	go build -ldflags="-X 'main.Version=$(BUILD_INFO)' \
		-X 'main.Commit=$(COMMIT_HASH)' \
		-X 'main.BuildDate=$(BUILD_DATE)'" \
		-o $(BIN_DIR)/$(APP_NAME) ./cmd/user-service
	@echo "‚úÖ Build complete: $(BIN_DIR)/$(APP_NAME)"

run: build
	@echo "üöÄ Starting User Service server..."
	@echo "Server will be available at: http://localhost:8081"
	@echo "Health check: http://localhost:8081/health"
	@echo ""
	@cd $(BIN_DIR) && ./$(APP_NAME) --config ../config.yaml

run-dev:
	@echo "üöÄ Starting in development mode..."
	@echo "For hot reload use: make dev"
	DEBUG=true go run ./cmd/user-service --config config.yaml

dev:
	@echo "üî• Starting with hot reload..."
	@if command -v air > /dev/null; then \
		air; \
	else \
		echo "‚ö† air is not installed. Install: go install github.com/cosmtrek/air@latest"; \
		echo "Running without hot reload..."; \
		make run-dev; \
	fi

## üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
migrate: build
	@echo "üîÑ Running migrations..."
	@echo "‚ö† Migrations not configured for user-service"
	@echo "Create migrations in db/migrations directory"

migrate-create: build
	@echo "üìù Creating migration..."
	@read -p "Enter migration name: " name; \
	echo "Create file: db/migrations/$${name}_up.sql and $${name}_down.sql"

worker: build
	@echo "üë∑ Starting workers..."
	@cd $(BIN_DIR) && ./$(APP_NAME) worker --workers 3 --queue user_tasks

health-check:
	@echo "‚ù§Ô∏è  Health checking service..."
	@if curl -s http://localhost:8081/health > /dev/null; then \
		echo "‚úÖ User Service is running"; \
	else \
		echo "‚ùå User Service is not available"; \
	fi

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
test: 
	@echo "üß™ Running all tests..."
	go test -v -race ./... -coverprofile=coverage.out
	go tool cover -func=coverage.out
	@echo "‚úÖ Tests completed"

test-api:
	@echo "üß™ Testing API..."
	@echo "Starting server in background..."
	@go run ./cmd/user-service --config config.yaml &
	@SERVER_PID=$$!
	@sleep 3
	@echo "Testing health endpoint..."
	@curl -s http://localhost:8081/health
	@echo ""
	@echo "Testing user endpoint..."
	@curl -s "http://localhost:8081/api/v1/user?id=test"
	@echo ""
	@kill $$SERVER_PID 2>/dev/null || true
	@echo "‚úÖ API tests completed"

test-db:
	@echo "üß™ Testing database..."
	@echo "‚ö† Database tests not configured"
	@echo "Configure database connection in config.yaml"

bench:
	@echo "üìä Running benchmarks..."
	go test -bench=. -benchmem ./...

load-test:
	@echo "‚ö° Running load tests..."
	@if command -v k6 > /dev/null; then \
		echo "Create scripts/loadtest.js first"; \
	else \
		echo "‚ö† k6 is not installed. Install: https://k6.io/docs/getting-started/installation/"; \
	fi

## üõ†Ô∏è  Code quality
lint:
	@echo "üîç Linting code..."
	@if command -v golangci-lint > /dev/null; then \
		golangci-lint run ./...; \
	else \
		echo "‚ö† golangci-lint is not installed"; \
	fi

vet:
	@echo "üîé Checking code with vet..."
	go vet ./...
	@echo "‚úÖ Vet completed"

fmt:
	@echo "üé® Formatting code..."
	go fmt ./...
	@echo "‚úÖ Formatting completed"

security-check:
	@echo "üîí Security checking..."
	@if command -v gosec > /dev/null; then \
		gosec ./...; \
	else \
		echo "‚ö† gosec is not installed. Install: go install github.com/securego/gosec/v2/cmd/gosec@latest"; \
	fi

## üìã –£—Ç–∏–ª–∏—Ç—ã
version: build
	@echo "üìã Version information:"
	@cd $(BIN_DIR) && ./$(APP_NAME) --version 2>/dev/null || echo "Version command not implemented"

generate-docs: build
	@echo "üìñ Generating documentation..."
	@echo "‚ö† Documentation generation not configured"
	@echo "Implement OpenAPI/Swagger documentation"

install-deps:
	@echo "üì¶ Installing dependencies..."
	go mod download
	go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
	go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
	@echo "‚úÖ Dependencies installed"

deps-update:
	@echo "üîÑ Updating dependencies..."
	go get -u ./...
	go mod tidy
	@echo "‚úÖ Dependencies updated"

init: install-deps proto
	@echo "‚úÖ Project initialized"

clean:
	@echo "üßπ Cleaning..."
	rm -rf $(BIN_DIR) coverage.out
	rm -rf pkg/gen
	go clean
	@echo "‚úÖ Clean completed"

## üåê Dual API (HTTP + gRPC)
run-dual:
	@echo "üöÄ Starting in DUAL mode (HTTP:8081 + gRPC:9091)..."
	@echo "HTTP REST: http://localhost:8081"
	@echo "gRPC:      localhost:9091"
	@echo ""
	go run ./cmd/user-service --config config.yaml --grpc-port=9091

test-dual:
	@echo "üß™ Testing DUAL API..."
	@echo "1. Starting server..."
	@make run-dual &
	@SERVER_PID=$$!
	@sleep 3
	@echo ""
	@echo "2. Testing HTTP API..."
	@curl -s http://localhost:8081/health
	@echo ""
	@echo ""
	@echo "3. Testing gRPC client..."
	@echo "‚ö† gRPC client not implemented"
	@echo ""
	@echo "4. Testing HTTP Python client..."
	@echo "‚ö† Python client not implemented"
	@echo ""
	@echo "‚úÖ Dual API tests completed"
	@kill $$SERVER_PID 2>/dev/null || true

grpc-client:
	@echo "üöÄ Running gRPC client..."
	@echo "‚ö† gRPC client not implemented"
	@echo "Create scripts/clients/test_grpc_client.go"

http-client:
	@echo "üåê Running HTTP client..."
	@echo "‚ö† HTTP client not implemented"
	@echo "Create scripts/clients/test_http_client.py"

## üöÄ Quick start
quick-start:
	@echo "üöÄ Quick start for User Service"
	@echo ""
	@echo "1. Initialize project:"
	@echo "   make init"
	@echo ""
	@echo "2. Generate proto files:"
	@echo "   make proto"
	@echo ""
	@echo "3. Run in development mode:"
	@echo "   make run-dev"
	@echo ""
	@echo "4. Test the service:"
	@echo "   make test-api"
	@echo ""
	@echo "üì° Service will be available at: http://localhost:8081"

2. PROTOBUF –§–ê–ô–õ–´ (–°–û–î–ï–†–ñ–ò–ú–û–ï)
===============================
=== common.proto ===
syntax = "proto3";

package common;
option go_package = "userservice/pkg/gen";

// –û–±—â–∏–π –æ—Ç–≤–µ—Ç API
message ApiResponse {
  string status = 1;
  string message = 2;
  int64 timestamp = 3;
  map<string, string> metadata = 4;
}

// –ü—É—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å
message EmptyRequest {}

// –û—à–∏–±–∫–∞
message Error {
  string code = 1;
  string message = 2;
  map<string, string> details = 3;
}

// –ü–∞–≥–∏–Ω–∞—Ü–∏—è
message Pagination {
  int32 page = 1;
  int32 limit = 2;
  int32 total = 3;
}

=== user.proto ===
syntax = "proto3";

package user;
option go_package = "userservice/pkg/gen";

import "common.proto";

// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
message User {
  string id = 1;
  string username = 2;
  string email = 3;
  string phone = 4;
  string status = 5; // active, inactive, banned
  int64 created_at = 6;
  int64 updated_at = 7;
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  message UserSettings {
    string default_quality = 1;
    int32 max_parallel_streams = 2;
    bool auto_start_recording = 3;
    bool notifications_enabled = 4;
    string timezone = 5;
    string language = 6;
  }
  
  // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞
  message StreamingConfig {
    string server_url = 1;
    int32 server_port = 2;
    bool use_ssl = 3;
    string api_key = 4;
    string stream_endpoint = 5;
    repeated string allowed_ips = 6;
    int32 max_bitrate = 7;
    int32 max_resolution = 8;
    repeated string allowed_codecs = 9;
  }
  
  // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  message UserStats {
    int64 total_streams = 1;
    int64 total_duration = 2; // –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    int64 total_storage_used = 3; // –≤ –±–∞–π—Ç–∞—Ö
    int64 current_streams = 4;
    int32 successful_logins = 5;
    int32 failed_logins = 6;
    int64 last_login = 7;
    int64 last_activity = 8;
  }
  
  UserSettings settings = 8;
  StreamingConfig streaming_config = 9;
  UserStats stats = 10;
  map<string, string> metadata = 11;
}

// –ó–∞–ø—Ä–æ—Å—ã
message GetUserRequest {
  string user_id = 1;
}

message GetUserByUsernameRequest {
  string username = 1;
}

message CreateUserRequest {
  string username = 1;
  string email = 2;
  string phone = 3;
  string password = 4;
}

message UpdateUserRequest {
  string user_id = 1;
  User user = 2;
}

message DeleteUserRequest {
  string user_id = 1;
}

message ListUsersRequest {
  int32 page = 1;
  int32 limit = 2;
  string filter = 3;
}

message ListUsersResponse {
  repeated User users = 1;
  int32 total = 2;
  int32 page = 3;
  int32 total_pages = 4;
}

// –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
message LoginRequest {
  string username = 1;
  string password = 2;
  string client_info = 3; // JSON —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–ª–∏–µ–Ω—Ç–µ
}

message LoginResponse {
  string token = 1;
  User user = 2;
  int64 expires_at = 3;
  string refresh_token = 4;
}

message ValidateTokenRequest {
  string token = 1;
}

message ValidateTokenResponse {
  bool valid = 1;
  User user = 2;
  string message = 3;
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞
message GetStreamingConfigRequest {
  string user_id = 1;
  string client_id = 2;
}

// –°–µ—Ä–≤–∏—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
service UserService {
  // –ë–∞–∑–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
  rpc GetUser(GetUserRequest) returns (User);
  rpc GetUserByUsername(GetUserByUsernameRequest) returns (User);
  rpc CreateUser(CreateUserRequest) returns (User);
  rpc UpdateUser(UpdateUserRequest) returns (User);
  rpc DeleteUser(DeleteUserRequest) returns (common.ApiResponse);
  rpc ListUsers(ListUsersRequest) returns (ListUsersResponse);
  
  // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
  rpc Login(LoginRequest) returns (LoginResponse);
  rpc ValidateToken(ValidateTokenRequest) returns (ValidateTokenResponse);
  rpc Logout(common.EmptyRequest) returns (common.ApiResponse);
  
  // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞
  rpc GetStreamingConfig(GetStreamingConfigRequest) returns (User.StreamingConfig);
  rpc UpdateStreamingConfig(UpdateUserRequest) returns (User.StreamingConfig);
  
  // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  rpc UpdateUserStats(UpdateUserRequest) returns (common.ApiResponse);
  rpc GetUserStats(GetUserRequest) returns (User.UserStats);
}


3. –ü–û–õ–ù–´–ï –°–¢–†–£–ö–¢–£–†–´ –î–ê–ù–ù–´–•
===========================
=== ClientInfo Service ===
–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: internal/controller/client_info_service.go

=== VideoStream Service ===
–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: internal/controller/video_stream_service.go


4. –†–ï–ü–û–ó–ò–¢–û–†–ò–ò
==============
–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: internal/controller/repository.go

5. ROUTER (–ü–û–õ–ù–´–ô)
==================
package app

import (
	"net/http"

	"github.com/gorilla/mux"
	"user-service/internal/controller"
)

func RegisterRoutes(ctrl *controller.Controller) *mux.Router {
	router := mux.NewRouter()

	// Health check
	router.HandleFunc("/health", ctrl.HealthCheck).Methods("GET")

	// API v1
	api := router.PathPrefix("/api/v1").Subrouter()

	// User endpoints
	api.HandleFunc("/users", ctrl.ListUsers).Methods("GET")
	api.HandleFunc("/users", ctrl.CreateUser).Methods("POST")
	api.HandleFunc("/users/{id}", ctrl.GetUser).Methods("GET")
	api.HandleFunc("/users/{id}", ctrl.UpdateUser).Methods("PUT")
	api.HandleFunc("/users/{id}", ctrl.DeleteUser).Methods("DELETE")

	// Auth endpoints
	api.HandleFunc("/auth/login", ctrl.Login).Methods("POST")
	api.HandleFunc("/auth/validate", ctrl.ValidateToken).Methods("POST")
	api.HandleFunc("/auth/logout", ctrl.Logout).Methods("POST")

	// Streaming config
	api.HandleFunc("/users/{id}/streaming-config", ctrl.GetStreamingConfig).Methods("GET")
	api.HandleFunc("/users/{id}/streaming-config", ctrl.UpdateStreamingConfig).Methods("PUT")

	// User stats
	api.HandleFunc("/users/{id}/stats", ctrl.GetUserStats).Methods("GET")

	return router
}

6. –ü–û–õ–ù–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
======================
=== application.go ===
package app

import (
	"context"
	"log"
	"net/http"
	"os"
	"os/signal"
	"syscall"
	"time"

	"user-service/internal/controller"
	"user-service/internal/repository"
	"user-service/internal/service"
)

// Application - –æ—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
type Application struct {
	Config     *Config
	HTTPServer *http.Server
	GRPCServer interface{} // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ
	Services   *service.Services
	Repos      *repository.Repositories
	Controller *controller.Controller
}

// Config - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
type Config struct {
	HTTPPort string
	GRPCPort string
	Env      string
	Database struct {
		DSN string
	}
}

// New —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
func New(config *Config) *Application {
	// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
	repos := repository.New()

	// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–µ—Ä–≤–∏—Å—ã
	services := service.New(repos)

	// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
	ctrl := controller.New(services)

	// –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º HTTP —Å–µ—Ä–≤–µ—Ä
	mux := ctrl.RegisterRoutes()

	server := &http.Server{
		Addr:         ":" + config.HTTPPort,
		Handler:      mux,
		ReadTimeout:  15 * time.Second,
		WriteTimeout: 15 * time.Second,
		IdleTimeout:  60 * time.Second,
	}

	return &Application{
		Config:     config,
		HTTPServer: server,
		Services:   services,
		Repos:      repos,
		Controller: ctrl,
	}
}

// Run –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
func (app *Application) Run() error {
	// –ö–∞–Ω–∞–ª –¥–ª—è –æ—à–∏–±–æ–∫
	errChan := make(chan error, 1)

	// –ó–∞–ø—É—Å–∫–∞–µ–º HTTP —Å–µ—Ä–≤–µ—Ä –≤ –≥–æ—Ä—É—Ç–∏–Ω–µ
	go func() {
		log.Printf("Starting HTTP server on port %s", app.Config.HTTPPort)
		if err := app.HTTPServer.ListenAndServe(); err != nil && err != http.ErrServerClosed {
			errChan <- err
		}
	}()

	// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è graceful shutdown
	quit := make(chan os.Signal, 1)
	signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)

	select {
	case <-quit:
		log.Println("Shutting down server...")
	case err := <-errChan:
		log.Printf("Server error: %v", err)
	}

	// Graceful shutdown
	ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
	defer cancel()

	if err := app.HTTPServer.Shutdown(ctx); err != nil {
		log.Printf("Server forced to shutdown: %v", err)
		return err
	}

	log.Println("Server stopped")
	return nil
}

// HealthCheck - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
func (app *Application) HealthCheck() bool {
	// –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î, –∫—ç—à—É –∏ —Ç.–¥.
	return true
}

7. DOCKER –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
======================
=== Dockerfile ===
FROM golang:1.21-alpine AS builder

WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –º–æ–¥—É–ª–µ–π
COPY go.mod go.sum ./
RUN go mod download

# –ö–æ–ø–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥
COPY . .

# –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o /user-service ./cmd/user-service

# –§–∏–Ω–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑
FROM alpine:latest

RUN apk --no-cache add ca-certificates tzdata

WORKDIR /root/

# –ö–æ–ø–∏—Ä—É–µ–º –±–∏–Ω–∞—Ä–Ω–∏–∫ –∏–∑ builder
COPY --from=builder /user-service .
COPY config.yaml ./

# –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ—Ä—Ç—ã
EXPOSE 8081 9091

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
CMD ["./user-service", "--config", "config.yaml"]


8. CI/CD –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
=====================

9. –¢–ï–°–¢–û–í–ê–Ø –°–¢–†–£–ö–¢–£–†–ê
=====================

10. –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–ê–ô–õ–´
========================
=== .gitignore ===
# Binaries
bin/
user-service
*.exe
*.exe~
*.dll
*.so
*.dylib

# Generated files
pkg/gen/

# Dependency directories
vendor/

# Test files
*.test
*.test.exe
coverage.out
*.cover

# Config files
config.yaml
.env
*.local.yaml

# IDE files
.vscode/
.idea/
*.swp

=== README.md ===
# User Service

–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –∏—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π —Å—Ç—Ä–∏–º–∏–Ω–≥–∞.

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```bash
# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
git clone <repository>
cd user-service

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
go mod tidy

# –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
make run-dev



=============================================
–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê
–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: project_diagnostic_20260105_001438.txt
